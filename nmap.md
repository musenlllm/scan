这段代码实现了一个使用Nmap指纹进行常规端口探测的模块。以下是对代码的详细解读：

### 包定义和导入

- 代码定义了一个名为`gonmap`的包。
- 导入了一些必要的库，包括日志记录、嵌入文件、错误处理、网络编程、正则表达式、排序、字符串转换、时间处理等。

### 全局变量

- 定义了一些全局变量，用于配置探测的参数，如`verbose`、`routines`、`useAllProbes`等。

### 日志函数

- 定义了四个日志函数`Debug`、`Info`、`Warn`和`Error`，根据`verbose`的值决定是否打印日志。

### 结构体定义

- 定义了多个结构体，包括`Target`（待探测的目标端口）、`Result`（输出的结果数据）、`Service`（获取的端口服务信息）、`Extras`（对应NMap的versioninfo信息）、`Details`（详细的结果数据）、`Match`（nmap-probes中每一条规则）、`Probe`（探针规则）等。

### 方法定义

- 为上述结构体定义了一系列方法，用于解析nmap-probes文件、处理匹配规则、发送探测请求、解析响应等。

### 配置和初始化

- 定义了`Config`结构体，用于配置VScan探测时的参数。
- 定义了`VScan`结构体，表示一个端口探测实例，包含排除规则、探针列表等。
- 实现了`VScan`的`Init`方法，用于从嵌入的文件系统中加载nmap-probes文件并解析探针列表。
- 实现了`VScan`的`Explore`方法，用于执行端口探测并返回结果。

### 主函数

- 定义了`gonmapinit`函数，用于初始化全局配置参数。
- 定义了`GoNmapInit`函数，用于创建并初始化一个VScan实例。
- 定义了`GoNmapScan`函数，用于执行端口探测并返回结果。

### 功能总结

这段代码实现了一个使用Nmap指纹进行端口探测的模块。通过定义数据结构和实现相关方法，它能够从嵌入的文件系统中加载探针列表，执行端口探测，并返回探测结果。用户可以通过调用`GoNmapInit`和`GoNmapScan`函数来初始化探测实例并执行端口探测。

这段代码是一个使用Nmap指纹进行常规端口探测的模块，主要包含了以下功能：

### 包定义和导入

- 定义了一个名为`gonmap`的包。
- 导入了必要的库，包括日志记录、嵌入文件、错误处理、网络编程、正则表达式、排序、字符串转换、时间处理等，这些库为代码提供了所需的功能。

### 全局变量

- 定义了一些全局变量，用于配置探测的参数，如`verbose`用于控制日志输出的详细程度，`routines`用于控制并发执行的探测任务数，`useAllProbes`用于控制是否使用所有探针进行探测等。

### 日志函数

- 定义了四个日志函数`Debug`、`Info`、`Warn`和`Error`，根据`verbose`的值决定是否打印日志。这些函数用于在程序执行过程中输出调试信息、普通信息、警告信息和错误信息，帮助开发者了解程序的运行状态和问题。

### 结构体定义

- 定义了多个结构体，用于表示不同的数据模型。
  - `Target`结构体表示待探测的目标端口，包含IP地址、端口号和协议类型。
  - `Result`结构体表示探测的结果，包含目标信息、服务信息、时间戳和错误信息。
  - `Service`结构体表示获取的端口服务信息，包含目标信息、服务名称、协议类型、Banner信息等。
  - `Extras`结构体表示NMap的versioninfo信息，包含供应商产品、版本、信息、主机名、操作系统、设备类型和CPE等。
  - `Details`结构体表示详细的结果数据，包含探针名称、探针数据、匹配规则和是否软匹配等。
  - `Match`结构体表示nmap-probes中每一条规则，包含是否软匹配、服务名称、模式和版本信息等。
  - `Probe`结构体表示探针规则，包含探针名称、数据、协议、端口范围、超时时间、稀有度和回退规则等。

### 方法定义

- 为上述结构体定义了一系列方法，用于实现不同的功能。
  - 解析nmap-probes文件并加载探针列表。
  - 处理匹配规则，将规则字符串转换为可用于编译的正则表达式。
  - 发送探测请求并接收响应。
  - 解析响应数据，提取服务信息。
  - 对探针列表进行排序。

### 配置和初始化

- 定义了`Config`结构体，用于配置VScan探测时的参数，如稀有度、发送超时时间、读取超时时间、是否仅使用NULL探针、是否使用所有探针等。
- 定义了`VScan`结构体，表示一个端口探测实例，包含排除规则、探针列表等。
- 实现了`VScan`的`Init`方法，用于从嵌入的文件系统中加载nmap-probes文件并解析探针列表。
- 实现了`VScan`的`Explore`方法，用于执行端口探测并返回结果。该方法根据配置选择探针，发送探测请求，解析响应，并返回探测结果。

### 主函数

- 定义了`gonmapinit`函数，用于初始化全局配置参数，如设置默认的配置值。
- 定义了`GoNmapInit`函数，用于创建并初始化一个VScan实例。该函数调用`gonmapinit`进行初始化，并调用`VScan`的`Init`方法加载探针列表。
- 定义了`GoNmapScan`函数，用于执行端口探测并返回结果。该函数接受目标IP、端口和协议作为参数，创建一个`Target`对象，并调用`VScan`的`Explore`方法进行探测。

通过调用`GoNmapInit`函数初始化VScan实例，并使用`GoNmapScan`函数执行端口探测，可以获得探测结果并返回给调用方。这样，用户可以利用这个模块进行端口探测，获取目标主机的服务信息和其他相关信息。

以下是代码中各个函数的具体描述：

1. **InitRedis**：
   - 功能：初始化Redis连接。
   - 实现：创建一个新的Redis客户端实例，并尝试与Redis服务器建立连接。如果连接成功，返回客户端实例；否则，记录错误日志并退出程序。

2. **CheckRedisConnect**：
   - 功能：检查Redis连接是否有效。
   - 实现：发送一个PING命令到Redis服务器，如果命令执行成功且返回"PONG"，则返回true；否则，返回false。

3. **RecvJob**：
   - 功能：从Redis的消息队列中接收任务。
   - 实现：使用BLPop命令从指定的消息队列中阻塞获取一个元素，并返回获取到的元素值。

4. **Debug**、**Info**、**Warn**、**Error**：
   - 功能：根据`verbose`的值决定是否打印日志。
   - 实现：根据`verbose`的值和日志级别，决定是否调用log.Println函数打印日志信息。

5. **Target.GetAddress**：
   - 功能：获取目标的地址字符串。
   - 实现：将目标的IP地址和端口号拼接成一个字符串，并返回。

6. **Match.MatchPattern**：
   - 功能：对获取到的Banner进行匹配。
   - 实现：使用正则表达式对Banner进行匹配，并返回匹配结果。

7. **Match.ParseVersionInfo**：
   - 功能：解析版本信息。
   - 实现：根据匹配结果和版本信息字符串，解析出供应商产品、版本、信息、主机名、操作系统、设备类型和CPE等信息，并返回。

8. **Probe.fromString**：
   - 功能：从字符串中解析Probe对象。
   - 实现：将包含Probe信息的字符串解析为Probe对象，并进行相应的处理。

9. **VScan.parseProbesFromContent**：
   - 功能：从内容中解析Probe列表。
   - 实现：从给定的内容中解析出Probe列表，并进行相应的处理。

10. **VScan.parseProbesToMapKName**：
    - 功能：将Probe列表转换为以名称为键的映射。
    - 实现：将Probe列表转换为一个以Probe名称为键，Probe对象为值的映射。

11. **VScan.Init**：
    - 功能：初始化VScan实例。
    - 实现：从嵌入的文件系统中加载nmap-probes文件，并解析Probe列表，初始化VScan实例。

12. **VScan.Explore**：
    - 功能：执行端口探测并返回结果。
    - 实现：根据配置选择探针，发送探测请求，解析响应，并返回探测结果。

13. **VScan.scanWithProbes**：
    - 功能：使用指定的探针进行端口探测。
    - 实现：使用给定的探针列表对目标进行探测，并返回探测结果。

14. **grabResponse**：
    - 功能：抓取响应数据。
    - 实现：根据目标信息建立连接，发送数据并接收响应，返回接收到的响应数据。

15. **gonmapinit**：
    - 功能：初始化全局配置参数。
    - 实现：设置默认的全局配置参数值。

16. **GoNmapInit**：
    - 功能：创建并初始化VScan实例。
    - 实现：调用`gonmapinit`进行初始化，并创建VScan实例，加载Probe列表。

17. **GoNmapScan**：
    - 功能：执行端口探测并返回结果。
    - 实现：创建目标对象，并调用VScan的`Explore`方法进行探测，返回探测结果。

这些函数共同构成了这个端口探测模块的功能，使得用户可以通过调用这些函数来初始化探测实例、执行端口探测、获取探测结果等。